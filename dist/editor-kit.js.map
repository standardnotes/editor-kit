{"version":3,"sources":["webpack://EditorKit/webpack/universalModuleDefinition","webpack://EditorKit/./node_modules/@standardnotes/component-relay/dist/dist.js","webpack://EditorKit/external \"filesafe-js\"","webpack://EditorKit/webpack/bootstrap","webpack://EditorKit/webpack/runtime/compat get default export","webpack://EditorKit/webpack/runtime/create fake namespace object","webpack://EditorKit/webpack/runtime/define property getters","webpack://EditorKit/webpack/runtime/hasOwnProperty shorthand","webpack://EditorKit/webpack/runtime/make namespace object","webpack://EditorKit/./src/utils.ts","webpack://EditorKit/./src/fileLoader.ts","webpack://EditorKit/./src/textExpander.ts","webpack://EditorKit/./src/fileSafeHtml.ts","webpack://EditorKit/./src/editorKit.ts"],"names":["htmlToText","html","tmpDocument","document","implementation","createHTMLDocument","body","innerHTML","textContent","innerText","truncateString","text","limit","length","substring","sleep","seconds","Promise","resolve","setTimeout","FileLoader","constructor","options","fileTypeForElementType","type","fileTypeToElementType","toLowerCase","loadFileSafeElements","elements","getElementsBySelector","element","loadFileSafeElement","fsElement","fileSafeInstance","fsid","getAttribute","fsName","fileNameDisplay","existingMapping","uuidToFileTempUrlAndTypeMapping","insertMediaElement","url","fileType","currentlyLoadingIds","includes","descriptor","findFileDescriptor","setStatus","status","removable","selectorSyntax","uuid","existingElements","querySelectorAll","cleanup","splice","indexOf","push","fileItem","downloadFileFromDescriptor","catch","data","decryptFile","fileDescriptor","content","tempUrl","createTemporaryFileUrl","base64Data","decryptedData","dataType","elementType","mediaElement","createImageElement","createVideoElement","createAudioElement","createDownloadElement","insertElementNearElement","remove","wrapElementInTag","tagName","tag","createElement","setAttribute","append","image","elementWidth","elementHeight","video","source","link","audio","existingStatusElement","statusElementMapping","style","fontWeight","userSelect","insertStatusAtCursor","identifier","Math","random","toString","removeCursorStatus","domNodeToInsert","inVicinityOfElement","processedElement","preprocessElement","insertionType","paragraphAncestor","closest","insertElement","TextExpander","onKeyUp","isEnter","isPaste","isSpace","searchPatterns","searchPreviousLine","params","getPreviousLineText","getCurrentLineText","pattern","patterns","match","regex","exec","matchedText","replaceWith","callback","replaceSelection","replacement","beforeExpand","replaceText","afterExpand","FileSafeSyntaxPattern","expandedFileSafeSyntax","replace","fileSafeSyntaxToHtmlElement","removeFileSafeSyntaxFromHtml","_match","insertionSyntaxForFileDescriptor","fileName","syntax","components","split","name","size","sizeString","dimensions","collapseFileSafeSyntax","domCopy","DOMParser","parseFromString","mediaElements","file","width","height","fsSyntax","join","insertAdjacentHTML","ghosts","forEach","ghost","EditorKitBase","delegate","connectToBridge","supportsFileSafe","fileSafeLoading","importFileSafe","coallesedSaving","coallesedSavingDelay","mode","componentRelay","ComponentRelay","targetWindow","window","onReady","platform","documentElement","classList","add","onThemesChange","streamContextItem","note","isNewNoteLoad","previousNote","itemClass","fileSafeClass","getSFItemClass","setCurrentNote","isMetadataUpdate","isHtml","test","ignoreNextTextChange","previousText","needsFileSafeElementLoad","onNoteValueChange","setEditorRawText","onNoteLockToggle","previousLockState","getItemAppDataValue","newLockState","clearUndoHistory","then","result","default","configureFileSafe","requiredDelegateFunctions","functionName","Error","componentManager","addDataChangeObserver","allFileDescriptors","getAllFileDescriptors","fileIdsPendingAssociation","hasMatch","slice","find","candidate","insertRawText","textExpander","fileLoader","addNewFileDescriptorHandler","getFileSafe","onEditorKeyUp","onEditorPaste","onEditorValueChanged","sameText","saveItemWithPresave","generateCustomPreview","preview_plain","plain","preview_html","preview","canUploadFiles","credentials","getAllCredentials","integrations","getAllIntegrations","uploadJSFileObject","cursorIdentifier","encryptAndUploadJavaScriptFileObject","presave","environment","canUseFileSafe","hasLegacyAccess"],"mappings":"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","file":"editor-kit.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory(require(\"filesafe-js\"));\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"EditorKit\", [\"filesafe-js\"], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"EditorKit\"] = factory(require(\"filesafe-js\"));\n\telse\n\t\troot[\"EditorKit\"] = factory(root[\"filesafe-js\"]);\n})(self, function(__WEBPACK_EXTERNAL_MODULE__695__) {\nreturn ","!function(e,t){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define(\"ComponentRelay\",[],t):\"object\"==typeof exports?exports.ComponentRelay=t():e.ComponentRelay=t()}(self,(function(){return(()=>{\"use strict\";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};let s,n,i,o;var a;e.d(t,{default:()=>w}),function(e){e.SetSize=\"set-size\",e.StreamItems=\"stream-items\",e.StreamContextItem=\"stream-context-item\",e.SaveItems=\"save-items\",e.SelectItem=\"select-item\",e.AssociateItem=\"associate-item\",e.DeassociateItem=\"deassociate-item\",e.ClearSelection=\"clear-selection\",e.CreateItem=\"create-item\",e.CreateItems=\"create-items\",e.DeleteItems=\"delete-items\",e.SetComponentData=\"set-component-data\",e.InstallLocalComponent=\"install-local-component\",e.ToggleActivateComponent=\"toggle-activate-component\",e.RequestPermissions=\"request-permissions\",e.PresentConflictResolution=\"present-conflict-resolution\",e.DuplicateItem=\"duplicate-item\",e.ComponentRegistered=\"component-registered\",e.ActivateThemes=\"themes\",e.Reply=\"reply\",e.SaveSuccess=\"save-success\",e.SaveError=\"save-error\",e.ThemesActivated=\"themes-activated\",e.KeyDown=\"key-down\",e.KeyUp=\"key-up\",e.Click=\"click\"}(s||(s={})),function(e){e[e.Web=1]=\"Web\",e[e.Desktop=2]=\"Desktop\",e[e.Mobile=3]=\"Mobile\"}(n||(n={})),function(e){e.Any=\"*\",e.Item=\"SF|Item\",e.RootKey=\"SN|RootKey|NoSync\",e.ItemsKey=\"SN|ItemsKey\",e.EncryptedStorage=\"SN|EncryptedStorage\",e.Note=\"Note\",e.Tag=\"Tag\",e.SmartTag=\"SN|SmartTag\",e.Component=\"SN|Component\",e.Editor=\"SN|Editor\",e.ActionsExtension=\"Extension\",e.UserPrefs=\"SN|UserPreferences\",e.HistorySession=\"SN|HistorySession\",e.Theme=\"SN|Theme\",e.Mfa=\"SF|MFA\",e.ServerExtension=\"SF|Extension\",e.FilesafeCredentials=\"SN|FileSafe|Credentials\",e.FilesafeFileMetadata=\"SN|FileSafe|FileMetadata\",e.FilesafeIntegration=\"SN|FileSafe|Integration\",e.ExtensionRepo=\"SN|ExtensionRepo\"}(i||(i={})),function(e){e.Pinned=\"pinned\",e.Archived=\"archived\",e.Locked=\"locked\",e.UserModifiedDate=\"client_updated_at\",e.DefaultEditor=\"defaultEditor\",e.MobileRules=\"mobileRules\",e.NotAvailableOnMobile=\"notAvailableOnMobile\",e.MobileActive=\"mobileActive\",e.LastSize=\"lastSize\",e.PrefersPlainEditor=\"prefersPlainEditor\",e.ComponentInstallError=\"installError\"}(o||(o={}));var r=new Uint8Array(16);function c(){if(!a&&!(a=\"undefined\"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||\"undefined\"!=typeof msCrypto&&\"function\"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error(\"crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported\");return a(r)}const m=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,l=function(e){return\"string\"==typeof e&&m.test(e)};for(var d=[],h=0;h<256;++h)d.push((h+256).toString(16).substr(1));const p=function(e,t,s){var n=(e=e||{}).random||(e.rng||c)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){s=s||0;for(var i=0;i<16;++i)t[s+i]=n[i];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+\"-\"+d[e[t+4]]+d[e[t+5]]+\"-\"+d[e[t+6]]+d[e[t+7]]+\"-\"+d[e[t+8]]+d[e[t+9]]+\"-\"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase();if(!l(s))throw TypeError(\"Stringified UUID is invalid\");return s}(n)},u=e=>{var t;const s={[n.Web]:\"web\",[n.Desktop]:\"desktop\",[n.Mobile]:\"mobile\"};return null!==(t=s[e])&&void 0!==t?t:s[n.Web]},v=e=>null!=e,g=()=>{};class f{static get isSupported(){return!(!window.console&&!console)}static get info(){return f.isSupported&&this.enabled?console.log.bind(console):g}static get error(){return f.isSupported?console.error.bind(console):g}}var y,S,b,I;function k(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?k(Object(s),!0).forEach((function(t){C(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):k(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function C(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}(S=\"enabled\")in(y=f)?Object.defineProperty(y,S,{value:false,enumerable:!0,configurable:!0,writable:!0}):y[S]=false,function(e){e.Component=\"component\"}(b||(b={})),function(e){e.Shift=\"Shift\",e.Ctrl=\"Control\",e.Meta=\"Meta\"}(I||(I={}));class w{constructor(e){if(C(this,\"contentWindow\",void 0),C(this,\"initialPermissions\",void 0),C(this,\"onReadyCallback\",void 0),C(this,\"component\",{activeThemes:[],acceptsThemes:!0}),C(this,\"sentMessages\",[]),C(this,\"messageQueue\",[]),C(this,\"lastStreamedItem\",void 0),C(this,\"pendingSaveItems\",void 0),C(this,\"pendingSaveTimeout\",void 0),C(this,\"pendingSaveParams\",void 0),C(this,\"coallesedSaving\",!0),C(this,\"coallesedSavingDelay\",250),C(this,\"messageHandler\",void 0),C(this,\"keyDownEventListener\",void 0),C(this,\"keyUpEventListener\",void 0),C(this,\"clickEventListener\",void 0),C(this,\"onThemesChangeCallback\",void 0),C(this,\"concernTimeouts\",[]),!e||!e.targetWindow)throw new Error(\"contentWindow must be a valid Window object.\");this.contentWindow=e.targetWindow,this.processParameters(e),this.registerMessageHandler(),this.registerKeyboardEventListeners(),this.registerMouseEventListeners()}processParameters(e){var t;const{initialPermissions:s,options:n,onReady:i,onThemesChange:o}=e;var a;s&&s.length>0&&(this.initialPermissions=s),v(null==n?void 0:n.coallesedSaving)&&(this.coallesedSaving=n.coallesedSaving),v(null==n?void 0:n.coallesedSavingDelay)&&(this.coallesedSavingDelay=n.coallesedSavingDelay),v(null==n?void 0:n.acceptsThemes)&&(this.component.acceptsThemes=null===(a=null==n?void 0:n.acceptsThemes)||void 0===a||a),v(i)&&(this.onReadyCallback=i),v(o)&&(this.onThemesChangeCallback=o),f.enabled=null!==(t=null==n?void 0:n.debug)&&void 0!==t&&t}deinit(){this.onReadyCallback=void 0,this.component={acceptsThemes:!0,activeThemes:[]},this.messageQueue=[],this.sentMessages=[],this.lastStreamedItem=void 0,this.pendingSaveItems=void 0,this.pendingSaveTimeout=void 0,this.pendingSaveParams=void 0,this.messageHandler&&(this.contentWindow.document.removeEventListener(\"message\",this.messageHandler),this.contentWindow.removeEventListener(\"message\",this.messageHandler)),this.keyDownEventListener&&this.contentWindow.removeEventListener(\"keydown\",this.keyDownEventListener),this.keyUpEventListener&&this.contentWindow.removeEventListener(\"keyup\",this.keyUpEventListener),this.clickEventListener&&this.contentWindow.removeEventListener(\"click\",this.clickEventListener)}registerMessageHandler(){this.messageHandler=e=>{if(f.info(\"Components API Message received:\",e.data),document.referrer&&new URL(document.referrer).origin!==new URL(e.origin).origin)return;const{data:t}=e,n=(e=>{if(\"string\"!=typeof e)return!1;try{const t=JSON.parse(e),s=Object.prototype.toString.call(t);return\"[object Object]\"===s||\"[object Array]\"===s}catch(e){return!1}})(t)?JSON.parse(t):t;if(n){if(void 0===this.component.origin&&n.action===s.ComponentRegistered)this.component.origin=e.origin;else if(e.origin!==this.component.origin)return;this.handleMessage(n)}else f.error(\"Invalid data received. Skipping...\")},this.contentWindow.document.addEventListener(\"message\",this.messageHandler,!1),this.contentWindow.addEventListener(\"message\",this.messageHandler,!1),f.info(\"Waiting for messages...\")}registerKeyboardEventListeners(){this.keyDownEventListener=e=>{f.info(\"A key has been pressed: \".concat(e.key)),e.ctrlKey?this.keyDownEvent(I.Ctrl):e.shiftKey?this.keyDownEvent(I.Shift):(e.metaKey||\"Meta\"===e.key)&&this.keyDownEvent(I.Meta)},this.keyUpEventListener=e=>{f.info(\"A key has been released: \".concat(e.key)),\"Control\"===e.key?this.keyUpEvent(I.Ctrl):\"Shift\"===e.key?this.keyUpEvent(I.Shift):\"Meta\"===e.key&&this.keyUpEvent(I.Meta)},this.contentWindow.addEventListener(\"keydown\",this.keyDownEventListener,!1),this.contentWindow.addEventListener(\"keyup\",this.keyUpEventListener,!1)}registerMouseEventListeners(){this.clickEventListener=e=>{f.info(\"A click has been performed.\"),this.mouseClickEvent()},this.contentWindow.addEventListener(\"click\",this.clickEventListener,!1)}handleMessage(e){switch(e.action){case s.ComponentRegistered:this.component.sessionKey=e.sessionKey,e.componentData&&(this.component.data=e.componentData),this.onReady(e.data),f.info(\"Component successfully registered with payload:\",e);break;case s.ActivateThemes:this.activateThemes(e.data.themes);break;default:{var t,n;if(!e.original)return;const s=null===(t=this.sentMessages)||void 0===t?void 0:t.filter((t=>{var s;return t.messageId===(null===(s=e.original)||void 0===s?void 0:s.messageId)}))[0];if(!s){const e=this.contentWindow.document.title,t=(\"The extension '\".concat(e,\"' is attempting to communicate with Standard Notes, \")+\"but an error is preventing it from doing so. Please restart this extension and try again.\").replace(\"  \",\" \");return void f.info(t)}null==s||null===(n=s.callback)||void 0===n||n.call(s,e.data);break}}}onReady(e){this.component.environment=e.environment,this.component.platform=e.platform,this.component.uuid=e.uuid,this.initialPermissions&&this.initialPermissions.length>0&&this.requestPermissions(this.initialPermissions);for(const e of this.messageQueue)this.postMessage(e.action,e.data,e.callback);this.messageQueue=[],f.info(\"Data passed to onReady:\",e),this.activateThemes(e.activeThemeUrls||[]),this.postMessage(s.ThemesActivated,{}),this.onReadyCallback&&this.onReadyCallback()}getSelfComponentUUID(){return this.component.uuid}isRunningInDesktopApplication(){return this.component.environment===u(n.Desktop)}isRunningInMobileApplication(){return this.component.environment===u(n.Mobile)}getComponentDataValueForKey(e){if(this.component.data)return this.component.data[e]}setComponentDataValueForKey(e,t){if(!this.component.data)throw new Error(\"The component has not been initialized.\");if(!e||e&&0===e.length)throw new Error(\"The key for the data value should be a valid string.\");this.component.data=E(E({},this.component.data),{},{[e]:t}),this.postMessage(s.SetComponentData,{componentData:this.component.data})}clearComponentData(){this.component.data={},this.postMessage(s.SetComponentData,{componentData:this.component.data})}postMessage(e,t,s){if(!this.component.sessionKey)return void this.messageQueue.push({action:e,data:t,api:b.Component,callback:s});const n={action:e,data:t,messageId:this.generateUUID(),sessionKey:this.component.sessionKey,api:b.Component},i=JSON.parse(JSON.stringify(n));let o;i.callback=s,this.sentMessages.push(i),o=this.isRunningInMobileApplication()?JSON.stringify(n):n,f.info(\"Posting message:\",o),this.contentWindow.parent.postMessage(o,this.component.origin)}requestPermissions(e,t){this.postMessage(s.RequestPermissions,{permissions:e},(()=>{t&&t()}))}activateThemes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(!this.component.acceptsThemes)return;f.info(\"Incoming themes:\",e);const{activeThemes:t}=this.component;if(t&&t.sort().toString()==e.sort().toString())return;let s=e;const n=[];for(const i of t)e.includes(i)?s=s.filter((e=>e!==i)):n.push(i);f.info(\"Deactivating themes:\",n),f.info(\"Activating themes:\",s);for(const e of n)this.deactivateTheme(e);this.component.activeThemes=e;for(const e of s){if(!e)continue;const t=this.contentWindow.document.createElement(\"link\");t.id=btoa(e),t.href=e,t.type=\"text/css\",t.rel=\"stylesheet\",t.media=\"screen,print\",t.className=\"custom-theme\",this.contentWindow.document.getElementsByTagName(\"head\")[0].appendChild(t)}this.onThemesChangeCallback&&this.onThemesChangeCallback()}themeElementForUrl(e){return Array.from(this.contentWindow.document.getElementsByClassName(\"custom-theme\")).slice().find((t=>t.id==btoa(e)))}deactivateTheme(e){const t=this.themeElementForUrl(e);t&&t.parentNode&&(t.setAttribute(\"disabled\",\"true\"),t.parentNode.removeChild(t))}generateUUID(){return p()}get platform(){return this.component.platform}get environment(){return this.component.environment}streamItems(e,t){this.postMessage(s.StreamItems,{content_types:e},(e=>{t(e.items)}))}streamContextItem(e){this.postMessage(s.StreamContextItem,{},(t=>{const{item:s}=t;(!this.lastStreamedItem||this.lastStreamedItem.uuid!==s.uuid)&&this.pendingSaveTimeout&&(clearTimeout(this.pendingSaveTimeout),this.performSavingOfItems(this.pendingSaveParams),this.pendingSaveTimeout=void 0,this.pendingSaveParams=void 0),this.lastStreamedItem=s,e(this.lastStreamedItem)}))}selectItem(e){this.postMessage(s.SelectItem,{item:this.jsonObjectForItem(e)})}clearSelection(){this.postMessage(s.ClearSelection,{content_type:i.Tag})}createItem(e,t){this.postMessage(s.CreateItem,{item:this.jsonObjectForItem(e)},(e=>{let{item:s}=e;!s&&e.items&&e.items.length>0&&(s=e.items[0]),this.associateItem(s),t&&t(s)}))}createItems(e,t){const n=e.map((e=>this.jsonObjectForItem(e)));this.postMessage(s.CreateItems,{items:n},(e=>{t&&t(e.items)}))}associateItem(e){this.postMessage(s.AssociateItem,{item:this.jsonObjectForItem(e)})}deassociateItem(e){this.postMessage(s.DeassociateItem,{item:this.jsonObjectForItem(e)})}deleteItem(e,t){this.deleteItems([e],t)}deleteItems(e,t){const n={items:e.map((e=>this.jsonObjectForItem(e)))};this.postMessage(s.DeleteItems,n,(e=>{t&&t(e)}))}sendCustomEvent(e,t,s){this.postMessage(e,t,(e=>{s&&s(e)}))}saveItem(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.saveItems([e],t,s)}saveItemWithPresave(e,t,s){this.saveItemsWithPresave([e],t,s)}saveItemsWithPresave(e,t,s){this.saveItems(e,s,!1,t)}performSavingOfItems(e){let{items:t,presave:n,callback:i}=e;const o=setTimeout((()=>{this.concernTimeouts.forEach((e=>clearTimeout(e))),alert(\"This editor is unable to communicate with Standard Notes. Your changes may not be saved. Please backup your changes, then restart the application and try again.\")}),5e3);this.concernTimeouts.push(o),n&&n();const a=[];for(const e of t)a.push(this.jsonObjectForItem(e));this.postMessage(s.SaveItems,{items:a},(()=>{this.concernTimeouts.forEach((e=>clearTimeout(e))),null==i||i()}))}saveItems(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;if(this.pendingSaveItems||(this.pendingSaveItems=[]),this.coallesedSaving&&!s){this.pendingSaveTimeout&&clearTimeout(this.pendingSaveTimeout);const s=e.map((e=>e.uuid)),i=this.pendingSaveItems.filter((e=>!s.includes(e.uuid)));this.pendingSaveItems=i.concat(e),this.pendingSaveParams={items:this.pendingSaveItems,presave:n,callback:t},this.pendingSaveTimeout=setTimeout((()=>{this.performSavingOfItems(this.pendingSaveParams),this.pendingSaveItems=[],this.pendingSaveTimeout=void 0,this.pendingSaveParams=null}),this.coallesedSavingDelay)}else this.performSavingOfItems({items:e,presave:n,callback:t})}setSize(e,t){this.postMessage(s.SetSize,{type:\"container\",width:e,height:t})}keyDownEvent(e){this.postMessage(s.KeyDown,{keyboardModifier:e})}keyUpEvent(e){this.postMessage(s.KeyUp,{keyboardModifier:e})}mouseClickEvent(){this.postMessage(s.Click,{})}jsonObjectForItem(e){const t=Object.assign({},e);return t.children=null,t.parent=null,t}getItemAppDataValue(e,t){var s,n;return null==e||null===(s=e.content)||void 0===s||null===(n=s.appData)||void 0===n?void 0:n[\"org.standardnotes.sn\"][t]}}return t.default})()}));\n//# sourceMappingURL=dist.js.map","module.exports = __WEBPACK_EXTERNAL_MODULE__695__;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","var getProto = Object.getPrototypeOf ? (obj) => (Object.getPrototypeOf(obj)) : (obj) => (obj.__proto__);\nvar leafPrototypes;\n// create a fake namespace object\n// mode & 1: value is a module id, require it\n// mode & 2: merge all properties of value into the ns\n// mode & 4: return value when already ns object\n// mode & 16: return value when it's Promise-like\n// mode & 8|1: behave like require\n__webpack_require__.t = function(value, mode) {\n\tif(mode & 1) value = this(value);\n\tif(mode & 8) return value;\n\tif(typeof value === 'object' && value) {\n\t\tif((mode & 4) && value.__esModule) return value;\n\t\tif((mode & 16) && typeof value.then === 'function') return value;\n\t}\n\tvar ns = Object.create(null);\n\t__webpack_require__.r(ns);\n\tvar def = {};\n\tleafPrototypes = leafPrototypes || [null, getProto({}), getProto([]), getProto(getProto)];\n\tfor(var current = mode & 2 && value; typeof current == 'object' && !~leafPrototypes.indexOf(current); current = getProto(current)) {\n\t\tObject.getOwnPropertyNames(current).forEach((key) => (def[key] = () => (value[key])));\n\t}\n\tdef['default'] = () => (value);\n\t__webpack_require__.d(ns, def);\n\treturn ns;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export const htmlToText = (html: string): string => {\n  const tmpDocument = document.implementation.createHTMLDocument().body\n  tmpDocument.innerHTML = html\n  return tmpDocument.textContent || tmpDocument.innerText || ''\n}\n\nexport const truncateString = (text: string, limit = 90): string => {\n  if (text.length <= limit) {\n    return text\n  }\n  return text.substring(0, limit) + '...'\n}\n\nexport const sleep = async (seconds: number): Promise<void> => {\n  await new Promise(resolve => setTimeout(resolve, seconds * 1000))\n}\n","import { sleep } from './utils'\n\nexport type FileLoaderOptions = {\n  fileSafeInstance: any\n  getElementsBySelector: (selector: string) => Element[]\n  preprocessElement: (element: Element) => Element\n  insertElement: (element: Element, inVicinityOfElement: Element | null, insertionType: string) => void\n}\n\ntype FileTypes = {\n  [key: string]: string\n}\n\ntype UuidTypeMapping = {\n  [key: string]: {\n    url: string\n    fileType: string\n    fsName: string\n  }\n}\n\ntype ElementStatusMapping = {\n  [key: string]: Element\n}\n\ntype InsertMediaElementParams = {\n  url: string,\n  fsid: string,\n  fsName: string,\n  fileType: string,\n  fsElement: Element\n}\n\ntype WrapElementInTagParams = {\n  element: Element,\n  tagName: string,\n  fsid: string,\n  fsName: string\n}\n\ntype SetStatusParams = {\n  status?: string,\n  fsElement: Element | null,\n  fsid: string,\n  removable?: boolean\n}\n\ntype CreateImageElementParams = {\n  url: string,\n  fsid: string,\n  fsName: string,\n  fsElement: Element\n}\n\ntype CreateAudioElementParams = {\n  url: string,\n  fsid: string,\n  fsName: string\n}\n\ntype CreateVideoElementParams = {\n  url: string,\n  fsid: string,\n  fileType: string,\n  fsName: string,\n  fsElement: Element\n}\n\ntype CreateDownloadElementParams = {\n  url: string,\n  fsid: string,\n  fsName: string\n}\n\nexport default class FileLoader {\n  /**\n   * When a file is decrypted and loaded into a temp url, we'll place the temp url in here so that subsequent decrypt attempts\n   * dont require further work. Mapped values have the shape of { url, fileType, fsName }\n   */\n  private uuidToFileTempUrlAndTypeMapping: UuidTypeMapping = {}\n\n  // The UUIDs of files currently loading, so that we don't start a new load for currently loading file.\n  private currentlyLoadingIds: string[] = []\n\n  // The UUID to current status element mapping\n  private statusElementMapping: ElementStatusMapping = {}\n  private readonly fileTypeToElementType: FileTypes = {\n    'image/png': 'img',\n    'image/jpg': 'img',\n    'image/jpeg': 'img',\n    'image/gif': 'img',\n    'image/tiff': 'img',\n    'image/bmp': 'img',\n    'video/mp4': 'video',\n    'audio/mpeg': 'audio',\n    'audio/mp3': 'audio'\n  }\n\n  constructor(private options: FileLoaderOptions) { }\n\n  public fileTypeForElementType(type: string): string {\n    return this.fileTypeToElementType[type.toLowerCase()]\n  }\n\n  /**\n   * Scans the document for elements <fileSafe>. If found, begins loading file.\n   */\n  public loadFileSafeElements(): void {\n    const elements = this.options.getElementsBySelector('*[fsplaceholder]')\n    for (const element of elements) {\n      this.loadFileSafeElement(element)\n    }\n  }\n\n  public async loadFileSafeElement(fsElement: Element): Promise<boolean> {\n    const { fileSafeInstance } = this.options\n\n    const fsid = fsElement.getAttribute('fsid')\n    const fsName = fsElement.getAttribute('fsName') ?? ''\n    const fileNameDisplay = (!fsName || fsName == 'undefined') ? 'file' : fsName\n\n    if (!fsid) {\n      return false\n    }\n\n    const existingMapping = this.uuidToFileTempUrlAndTypeMapping[fsid]\n\n    if (existingMapping) {\n      this.insertMediaElement({\n        fsid,\n        fsElement,\n        url: existingMapping.url,\n        fileType: existingMapping.fileType,\n        fsName: existingMapping.fsName\n      })\n      return false\n    }\n\n    if (this.currentlyLoadingIds.includes(fsid)) {\n      return false\n    }\n\n    const descriptor = fileSafeInstance.findFileDescriptor(fsid)\n\n    if (!descriptor) {\n      this.setStatus({\n        fsElement,\n        fsid,\n        status: `Unable to find ${fileNameDisplay} ${fsid}.`,\n        removable: true\n      })\n      return false\n    }\n\n    const selectorSyntax = `[fsid=\"${descriptor.uuid}\"][fscollapsable]`\n    const existingElements = document.querySelectorAll(\n      `img${selectorSyntax}, figure${selectorSyntax}, video${selectorSyntax}, audio${selectorSyntax}`\n    )\n\n    if (existingElements.length > 0) {\n      return false\n    }\n\n    const cleanup = () => this.currentlyLoadingIds.splice(this.currentlyLoadingIds.indexOf(fsid), 1)\n\n    this.currentlyLoadingIds.push(fsid)\n    this.setStatus({\n      fsElement,\n      fsid,\n      status: `Downloading ${fileNameDisplay}...`\n    })\n\n     // Allow UI to update before beginning download...\n    await sleep(0.05)\n\n    const fileItem = await fileSafeInstance.downloadFileFromDescriptor(descriptor).catch(() => {\n      this.setStatus({\n        fsElement,\n        fsid,\n        status: `Unable to download ${fileNameDisplay} ${fsid}.`\n      })\n      return\n    })\n\n    if (!fileItem) {\n      return false\n    }\n\n    this.setStatus({\n      fsElement,\n      fsid,\n      status: `Decrypting ${fileNameDisplay}...`\n    })\n\n    // Allow UI to update before beginning decryption\n    await sleep(0.05)\n\n    const data = await fileSafeInstance.decryptFile({ fileDescriptor: descriptor, fileItem }).catch(() => {\n      this.setStatus({\n        fsElement,\n        fsid,\n        status: `Unable to decrypt ${fileNameDisplay} ${fsid}.`\n      })\n      return\n    })\n\n    if (!data) {\n      return false\n    }\n\n    // Remove loading text\n    this.setStatus({\n      fsElement,\n      fsid\n    })\n\n    // Allow UI to update before adding image\n    await sleep(0.05)\n\n    // Generate temporary url, must be released later\n    const fileType = descriptor.content.fileType\n    const tempUrl = fileSafeInstance.createTemporaryFileUrl({\n      base64Data: data.decryptedData,\n      dataType: fileType\n    })\n\n    this.insertMediaElement({\n      fsid, fileType,\n      fsName,\n      fsElement,\n      url: tempUrl\n    })\n\n    cleanup()\n\n    this.uuidToFileTempUrlAndTypeMapping[fsid] = {\n      fileType,\n      url: tempUrl,\n      fsName,\n    }\n\n    return true\n  }\n\n  private insertMediaElement({ url, fsid, fsName, fileType, fsElement }: InsertMediaElementParams) {\n    const elementType = this.fileTypeForElementType(fileType)\n\n    let mediaElement: Element\n    \n    switch (elementType) {\n      case 'img':\n        mediaElement = this.createImageElement({ url, fsid, fsName, fsElement })\n        break\n      case 'video':\n        mediaElement = this.createVideoElement({ url, fsid, fileType, fsName, fsElement })\n        break\n      case 'audio':\n        mediaElement = this.createAudioElement({ url, fsid, fsName })\n        break\n      default:\n        mediaElement = this.createDownloadElement({ url, fsid, fsName })\n        break\n    }\n\n    this.insertElementNearElement(mediaElement, fsElement)\n\n    // Remove fsElement now that image is loaded.\n    fsElement.remove()\n  }\n\n  private wrapElementInTag({ element, tagName, fsid, fsName }: WrapElementInTagParams) {\n    const tag = document.createElement(tagName)\n    tag.setAttribute('fsid', fsid)\n    tag.setAttribute('fsName', fsName)\n    tag.setAttribute('fscollapsable', 'true')\n    tag.setAttribute('contenteditable', 'true')\n    tag.append(element)\n    return tag\n  }\n\n  private createImageElement({ url, fsid, fsName, fsElement }: CreateImageElementParams): HTMLImageElement {\n    const image = document.createElement('img')\n    image.setAttribute('src', url)\n    image.setAttribute('srcset', `${url} 2x`)\n\n    image.setAttribute('fsid', fsid)\n    image.setAttribute('fsName', fsName)\n    image.setAttribute('fscollapsable', 'true')\n\n    const elementWidth = fsElement.getAttribute('width')\n    if (elementWidth) {\n      image.setAttribute('width', elementWidth)\n    }\n\n    const elementHeight = fsElement.getAttribute('height')\n    if (elementHeight) {\n      image.setAttribute('height', elementHeight)\n    }\n\n    return image\n  }\n\n  private createVideoElement({ url, fsid, fileType, fsName, fsElement }: CreateVideoElementParams) {\n    const video = document.createElement('video')\n    video.setAttribute('controls', 'true')\n    video.setAttribute('fsid', fsid)\n    video.setAttribute('fsName', fsName)\n    video.setAttribute('fscollapsable', 'true')\n\n    const elementWidth = fsElement.getAttribute('width')\n    if (elementWidth) {\n      video.setAttribute('width', elementWidth)\n    }\n\n    const elementHeight = fsElement.getAttribute('height')\n    if (elementHeight) {\n      video.setAttribute('height', elementHeight)\n    }\n\n    const source = document.createElement('source')\n    source.setAttribute('src', url)\n    source.setAttribute('type', fileType)\n    video.append(source)\n\n    /**\n     * Redactor will automatically insert a video element in a p tag,\n     * so we'll do it ourselves so that we can control its attributes.\n     */\n    return this.wrapElementInTag({\n      fsid,\n      fsName,\n      element: video,\n      tagName: 'p'\n    })\n  }\n\n  private createDownloadElement({ url, fsid, fsName }: CreateDownloadElementParams) {\n    const link = document.createElement('a')\n    link.setAttribute('fsid', fsid)\n    link.setAttribute('fsName', fsName)\n    link.setAttribute('ghost', 'true')\n    link.setAttribute('fscollapsable', 'true')\n    link.setAttribute('href', url)\n    link.textContent = `${fsName}`\n    return link\n  }\n\n  private createAudioElement({ url, fsid, fsName }: CreateAudioElementParams) {\n    const audio = document.createElement('audio')\n    audio.setAttribute('src', url)\n    audio.setAttribute('controls', 'true')\n    audio.setAttribute('fsid', fsid)\n    audio.setAttribute('fsName', fsName)\n    audio.setAttribute('fscollapsable', 'true')\n\n    return this.wrapElementInTag({\n      fsid,\n      fsName,\n      element: audio,\n      tagName: 'p'\n    })\n  }\n\n  private setStatus({ status, fsElement, fsid, removable = false }: SetStatusParams): Element | void {\n    if (fsid) {\n      const existingStatusElement = this.statusElementMapping[fsid]\n\n      if (existingStatusElement) {\n        existingStatusElement.remove()\n        delete this.statusElementMapping[fsid]\n      }\n    }\n\n    if (status) {\n      let element = document.createElement('label')\n\n      element.setAttribute('id', fsid)\n      element.setAttribute('ghost', 'true')\n      element.setAttribute('contenteditable', 'false')\n      element.style.fontWeight = 'bold'\n      element.textContent = status\n\n      if (removable) {\n        element.style.userSelect = 'all'\n      }\n\n      element = this.insertElementNearElement(element, fsElement) as HTMLLabelElement\n\n      if (fsid) {\n        this.statusElementMapping[fsid] = element\n      }\n\n      return element\n    }\n  }\n\n  public insertStatusAtCursor(status: string): string {\n    const identifier = Math.random().toString(36).substring(7)\n    this.setStatus({\n      status,\n      fsid: identifier,\n      fsElement: null\n    })\n    return identifier\n  }\n\n  public removeCursorStatus(identifier: string): void {\n    /**\n     * We want to search for the element based on identifier, because the actual element\n     * inserted may have been done so as raw HTML, and not via an element pointer.\n     */\n    const elements = this.options.getElementsBySelector(`#${identifier}`)\n\n    if (elements.length > 0) {\n      elements[0].remove()\n    }\n  }\n\n  public insertElementNearElement(domNodeToInsert: Element, inVicinityOfElement: Element | null): Element | undefined {\n    const processedElement = this.options.preprocessElement(domNodeToInsert)\n    let insertionType = 'child'\n\n    // <figure> tags cannot be nested inside p tags.\n    if (inVicinityOfElement && processedElement.tagName.toLowerCase() == 'figure') {\n      // If we have a p ancestor, we need to get out.\n      const paragraphAncestor = inVicinityOfElement.closest('p')\n\n      if (paragraphAncestor) {\n        /**\n         * p tags cannot be nested in other p tags, so if we found one, we know its parent isn't and doesn't belong to a p tag.\n         * Add the new one right after paragraphAncestor.\n         */\n        inVicinityOfElement = paragraphAncestor\n        insertionType = 'afterend'\n      }\n    }\n\n    this.options.insertElement(processedElement, inVicinityOfElement, insertionType)\n    return processedElement as Element\n  }\n}\n","type Pattern = {\n  regex: RegExp\n  callback: (matchedText: string) => string\n}\n\nexport type TextExpanderOptions = {\n  patterns: Pattern[]\n  beforeExpand?: () => void\n  afterExpand?: () => void\n  getCurrentLineText: () => string\n  getPreviousLineText: () => string\n  replaceText: ({ regex: RegExp, replacement: string, searchPreviousLine: boolean }) => string\n}\n\ntype OnKeyUpParams = {\n  isEnter?: boolean\n  isPaste?: boolean\n  isSpace?: boolean\n}\n\ntype SearchPatternsParams = {\n  searchPreviousLine: boolean\n}\n\nexport default class TextExpander {\n  constructor (private options: TextExpanderOptions) { }\n\n  public onKeyUp ({ isEnter, isPaste, isSpace }: OnKeyUpParams): void {\n    if (isEnter || isPaste || isSpace) {\n      this.searchPatterns({\n        searchPreviousLine: isEnter ?? false\n      })\n    }\n  }\n\n  public searchPatterns (params: SearchPatternsParams = { searchPreviousLine: false }): void {\n    const text = (params.searchPreviousLine) ?\n      this.options.getPreviousLineText() : this.options.getCurrentLineText()\n\n    for (const pattern of this.options.patterns) {\n      const match = pattern.regex.exec(text)\n      if (!match) continue\n\n      const matchedText = match[0]\n\n      if (matchedText) {\n        const replaceWith = pattern.callback(matchedText)\n        this.replaceSelection(pattern.regex, replaceWith, params.searchPreviousLine)\n      }\n    }\n  }\n\n  private replaceSelection (regex: RegExp, replacement: string, searchPreviousLine: boolean): void {\n    if (this.options?.beforeExpand) {\n      this.options.beforeExpand()\n    }\n\n    this.options.replaceText({\n      regex,\n      replacement,\n      searchPreviousLine\n    })\n\n    if (this.options?.afterExpand) {\n      this.options?.afterExpand()\n    }\n  }\n}\n","export type FileSafeFileMetadata = {\n  [key: string]: any;\n}\n\n/**\n * Remove matching <p> tags if present.\n * Also capable of matching adjacent [fsSyntax][fsSyntax]\n */\nexport const FileSafeSyntaxPattern = /(<p>)?\\[FileSafe[^\\]]*\\](<\\/p>)?/g\n\n/**\n * Given an HTML string that includes substrings matching `FileSafeSyntaxPattern`,\n * replace occurences with ghost div element <fileSafe uuid='123'>\n */\nexport const expandedFileSafeSyntax = (html: string): string => {\n  return html.replace(FileSafeSyntaxPattern, (match) => {\n    return fileSafeSyntaxToHtmlElement(match)\n  })\n}\n\nexport const removeFileSafeSyntaxFromHtml = (html: string): string => {\n  return html.replace(FileSafeSyntaxPattern, (_match) => {\n    return ''\n  })\n}\n\nexport const insertionSyntaxForFileDescriptor = (descriptor: FileSafeFileMetadata): string => {\n  return `[FileSafe:${descriptor.uuid}:${descriptor.content.fileName}]`\n}\n\nexport const fileSafeSyntaxToHtmlElement = (syntax: string): string => {\n  // Remove paragraph tags\n  syntax = syntax.replace('<p>', '')\n  syntax = syntax.replace('</p>', '')\n\n  // Remove brackets\n  syntax = syntax.replace('[', '').replace(']', '')\n\n  const components = syntax.split(':')\n  const uuid = components[1]\n  const name = components[2]\n  const size = components[3]\n\n  let sizeString = ''\n\n  if (size) {\n    const dimensions = size.split('x')\n    sizeString = `width=${dimensions[0]} height=${dimensions[1]}`\n  }\n\n  /**\n   * We use a p tag here because if we try something custom, like `fileSafe` tag, the editor will automatically\n   * wrap it in a p tag, causing littered p tags remaining in the plaintext representation.\n   */\n  return `<p fsplaceholder=true style='display: none;' fscollapsable=true ghost=true fsid='${uuid}' fsname='${name}' ${sizeString}></p>`\n}\n\n/**\n * Given a rendered HTML string, replace all <fileSafe> items with [FileSafe:UUID] plaintext items.\n * Also, for any elements that have the 'ghost' attribute, remove it from the resulting string.\n */\nexport const collapseFileSafeSyntax = (html: string): string => {\n  const domCopy = new DOMParser().parseFromString(html, 'text/html')\n\n  // Elements that have fscollapsable means they should be collapsed to plain syntax.\n  const mediaElements = domCopy.querySelectorAll('*[fscollapsable]')\n\n  for (const file of mediaElements) {\n    const uuid = file.getAttribute('fsid')\n    const name = file.getAttribute('fsname')\n    const width = file.getAttribute('width')\n    const height = file.getAttribute('height')\n\n    const components = ['FileSafe', uuid, name]\n\n    if (width && height) {\n      const size = `${width}x${height}`\n      components.push(size)\n    }\n\n    const fsSyntax = `<p>[${components.join(':')}]</p>`\n    file.insertAdjacentHTML('afterend', fsSyntax)\n    file.remove()\n  }\n\n  // Remove any remaining ghost elements.\n  const ghosts = domCopy.querySelectorAll('*[ghost]')\n  ghosts.forEach((ghost) => ghost.remove())\n\n  return domCopy.body.innerHTML\n}\n","import ComponentRelay from '@standardnotes/component-relay'\nimport FileLoader, { FileLoaderOptions } from './fileLoader'\nimport TextExpander, { TextExpanderOptions } from './textExpander'\nimport {\n  truncateString,\n  htmlToText\n} from './utils'\nimport {\n  FileSafeSyntaxPattern,\n  collapseFileSafeSyntax,\n  expandedFileSafeSyntax,\n  insertionSyntaxForFileDescriptor,\n  removeFileSafeSyntaxFromHtml,\n  FileSafeFileMetadata\n} from './fileSafeHtml'\nimport type { ItemMessagePayload } from '@standardnotes/snjs'\n\n/**\n * The delegate is responsible for responding to events and functions that the EditorKit requires.\n * For example, when EditorKit wants to insert a new HTML element, it won't neccessarily know how,\n * because it's not designed for any particular editor. Instead, it will tell the delegate to\n * insert the element. The consumer of this API, the actual editor, would configure this delegate\n * with the appropriate callbacks.\n */\nexport interface EditorKitDelegate {\n  insertRawText?: (text: string) => void\n  setEditorRawText: (text: string) => void\n  getCurrentLineText?: TextExpanderOptions['getCurrentLineText']\n  getPreviousLineText?: TextExpanderOptions['getPreviousLineText']\n  replaceText?: TextExpanderOptions['replaceText']\n  getElementsBySelector?: FileLoaderOptions['getElementsBySelector']\n  insertElement?: FileLoaderOptions['insertElement']\n  preprocessElement?: FileLoaderOptions['preprocessElement']\n  clearUndoHistory?: () => void\n  generateCustomPreview?: (text: string) => { html?: string, plain: string }\n  onNoteLockToggle?: (isLocked: boolean) => void\n  onNoteValueChange?: (note: ItemMessagePayload) => Promise<void>\n  onThemesChange?: () => void\n}\n\nexport type EditorKitMode = 'plaintext' | 'html' | 'markdown' | 'json';\n\ntype EditorKitOptions = {\n  mode: EditorKitMode\n  /**\n   * Indicates if the editor should support FileSafe integration.\n   */\n  supportsFileSafe?: false\n  /**\n   * For Component Relay saving. Indicates if debouncer is enabled.\n   */\n  coallesedSaving?: false\n  /**\n   * For Component Relay saving. Indicates what the debouncer ms delay should be set to.\n   */\n  coallesedSavingDelay?: 250\n}\n\ntype OnEditorKeyUpParams = {\n  isSpace: boolean\n  isEnter: boolean\n}\n\ntype FileUuid = string\n\nexport default class EditorKitBase {\n  private fileIdsPendingAssociation: FileUuid[] = []\n  private componentRelay?: ComponentRelay\n  private fileLoader?: FileLoader\n  private textExpander?: TextExpander\n\n  private fileSafeLoading?: Promise<void>\n  private fileSafeClass?: any\n  private fileSafeInstance?: any\n\n  private note?: ItemMessagePayload\n  private ignoreNextTextChange?: boolean\n  private needsFileSafeElementLoad?: boolean\n  private previousText?: string\n\n  constructor(private delegate: EditorKitDelegate, private options: EditorKitOptions) {\n    this.connectToBridge()\n\n    if (this.options.supportsFileSafe) {\n      this.fileSafeLoading = this.importFileSafe()\n    }\n  }\n\n  private connectToBridge() {\n    const {\n      coallesedSaving,\n      coallesedSavingDelay,\n      mode,\n      supportsFileSafe\n    } = this.options\n\n    this.componentRelay = new ComponentRelay({\n      targetWindow: window,\n      options: {\n        coallesedSaving,\n        /**\n         * The editor does some debouncing for us, so we'll lower the\n         * default debounce value from 250 to 150\n         */\n        coallesedSavingDelay\n      },\n      onReady: () => {\n        const { platform } = this.componentRelay!\n\n        if (platform) {\n          document.documentElement.classList.add(platform)\n        }\n      },\n      onThemesChange: this.delegate.onThemesChange\n    })\n\n    this.componentRelay.streamContextItem(async (note: ItemMessagePayload) => {\n      /**\n       * TODO: If note has changed, release previous temp object URLs.\n       */\n      let isNewNoteLoad = true\n      if (this.note && this.note.uuid == note.uuid) {\n        isNewNoteLoad = false\n      }\n\n      const previousNote = this.note\n\n      if (supportsFileSafe) {\n        const itemClass = this.fileSafeClass.getSFItemClass()\n        this.note = new itemClass(note)\n        this.fileSafeInstance.setCurrentNote(this.note)\n      } else {\n        this.note = note\n      }\n\n       // Only update UI on non-metadata updates.\n      if (note.isMetadataUpdate) {\n        return\n      }\n\n      let text = note.content.text\n\n      /**\n       * If we're an HTML editor, and we're dealing with a new note,\n       * check to see if it's in html format.\n       * If it's not, we don't want to convert it to HTML until the user makes an explicit change\n       * so we'll ignore the next change event in this case.\n       */\n      if (mode === 'html' && isNewNoteLoad) {\n        const isHtml = /<[a-z][\\s\\S]*>/i.test(text)\n        if (!isHtml) {\n          this.ignoreNextTextChange = true\n        }\n      }\n\n      /**\n       * Set before expanding. \n       * We want this value to always be the collapsed value\n       */\n      this.previousText = text\n\n      if (supportsFileSafe) {\n        /**\n         * We want to expand any filesafe syntax in the text,\n         * but only after the text has been inserted.\n         * (Will be checked on editor change callback)\n         */\n        this.needsFileSafeElementLoad = true\n        text = expandedFileSafeSyntax(text)\n      }\n\n      this.delegate.onNoteValueChange && await this.delegate.onNoteValueChange(note)\n      this.delegate.setEditorRawText(text)\n\n      if (this.delegate.onNoteLockToggle) {\n        const previousLockState = this.componentRelay!.getItemAppDataValue(previousNote, 'locked') ?? false\n        const newLockState = this.componentRelay!.getItemAppDataValue(this.note, 'locked') ?? false\n\n        if (previousLockState !== newLockState) {\n          this.delegate.onNoteLockToggle(newLockState)\n        }\n      }\n\n      if (isNewNoteLoad) {\n        this.delegate.clearUndoHistory?.()\n      }\n    })\n  }\n\n  private async importFileSafe() {\n    return import('filesafe-js').then((result) => {\n      this.fileSafeClass = result.default\n      this.configureFileSafe()\n      return this.fileSafeInstance\n    })\n  }\n\n  private configureFileSafe() {\n    const requiredDelegateFunctions = [\n      'getCurrentLineText',\n      'getPreviousLineText',\n      'replaceText',\n      'getElementsBySelector',\n      'insertElement',\n      'preprocessElement',\n      'insertRawText'\n    ]\n\n    for (const functionName of requiredDelegateFunctions) {\n      if (!this.delegate[functionName]) {\n        throw Error(`Missing ${functionName} delegate function.`)\n      }\n    }\n\n    this.fileSafeInstance = new this.fileSafeClass({\n      componentManager: this.componentRelay\n    })\n\n    this.fileSafeInstance.addDataChangeObserver(() => {\n      // Reload UI by querying FileSafe for changes...\n      const allFileDescriptors = this.fileSafeInstance.getAllFileDescriptors()\n\n      if (this.note && this.fileIdsPendingAssociation.length > 0) {\n        let hasMatch = false\n\n        for (const uuid of this.fileIdsPendingAssociation.slice()) {\n          const descriptor = allFileDescriptors.find((candidate: FileSafeFileMetadata) => candidate.uuid == uuid)\n\n          if (!descriptor) {\n            continue\n          }\n\n          hasMatch = true\n          this.fileIdsPendingAssociation.splice(this.fileIdsPendingAssociation.indexOf(uuid), 1)\n\n          const syntax = insertionSyntaxForFileDescriptor(descriptor)\n          this.delegate.insertRawText!(syntax)\n        }\n\n        if (hasMatch) {\n          this.textExpander!.searchPatterns()\n        }\n      }\n\n      if (allFileDescriptors.length > 0) {\n        this.fileLoader!.loadFileSafeElements()\n      }\n    })\n\n    this.fileSafeInstance.addNewFileDescriptorHandler((fileDescriptor: FileSafeFileMetadata) => {\n      /**\n       * Called when a new file is uploaded. We'll wait until the bridge acknowledges\n       * receipt of this item, and then it will be added to the editor.\n       */\n      this.fileIdsPendingAssociation.push(fileDescriptor.uuid)\n    })\n\n    this.fileLoader = new FileLoader({\n      fileSafeInstance: this.fileSafeInstance,\n      getElementsBySelector: this.delegate.getElementsBySelector!,\n      insertElement: this.delegate.insertElement!,\n      preprocessElement: this.delegate.preprocessElement!\n    })\n\n    this.textExpander = new TextExpander({\n      afterExpand: () => this.fileLoader!.loadFileSafeElements(),\n      getCurrentLineText: this.delegate.getCurrentLineText!,\n      getPreviousLineText: this.delegate.getPreviousLineText!,\n      replaceText: this.delegate.replaceText!,\n      patterns: [{\n        regex: FileSafeSyntaxPattern,\n        callback: (matchedText) => {\n          return expandedFileSafeSyntax(matchedText)\n        }\n      }]\n    })\n  }\n\n  /**\n   * Gets the FileSafe class.\n   * @returns FileSafe class.\n   */\n  public async getFileSafe(): Promise<void> {\n    if (!this.fileSafeInstance && this.fileSafeLoading) {\n      return this.fileSafeLoading\n    }\n    return this.importFileSafe()\n  }\n\n  /**\n   * Called by consumer when the editor has a keyup event.\n   */\n  public onEditorKeyUp({ isSpace, isEnter }: OnEditorKeyUpParams): void {\n    this.textExpander!.onKeyUp({\n       isSpace,\n       isEnter\n    })\n  }\n\n  /**\n   * Called by consumer when user pastes into editor.\n   */\n  public onEditorPaste(): void {\n    this.textExpander!.onKeyUp({\n      isPaste: true\n    })\n  }\n\n  /**\n   * Called by consumer when the editor has a change/input event.\n   */\n  public onEditorValueChanged(text: string): void {\n    const { mode, supportsFileSafe } = this.options\n\n    if (this.needsFileSafeElementLoad) {\n      this.needsFileSafeElementLoad = false\n      this.fileLoader!.loadFileSafeElements()\n    }\n\n    if (this.ignoreNextTextChange) {\n      this.ignoreNextTextChange = false\n      return\n    }\n\n    if (supportsFileSafe) {\n      text = collapseFileSafeSyntax(text)\n\n      /**\n       * Change events may be triggered several times when expanding filesafe syntax.\n       * Ultimately, while the visual layer is changing a lot, the underlying text layer,\n       * after being collapsed, will not change. So we'll compare the previous html to new collapsed html before continuing.\n       */\n      const sameText = this.previousText == text\n      if (sameText) {\n        return\n      }\n    }\n\n    this.previousText = text\n\n    if (!this.note) {\n      return\n    }\n\n    const note = this.note\n\n    this.componentRelay!.saveItemWithPresave(note, () => {\n      note.content.text = text\n\n      if (this.delegate.generateCustomPreview) {\n        const result = this.delegate.generateCustomPreview(text)\n\n        note.content.preview_plain = result.plain ?? ' '\n        note.content.preview_html = result.html\n      } else {\n        if (mode === 'html') {\n          let preview = removeFileSafeSyntaxFromHtml(text)\n          preview = truncateString(htmlToText(preview))\n          /**\n           * If the preview has no length due to either being an empty note, or having just 1 FileSafe file\n           * that is stripped above, then we don't want to set to empty string, otherwise SN app will default to content\n           * for preview. We'll set a whitespace preview instead so SN doesn't go based on innate content.\n           */\n          note.content.preview_plain = preview.length > 0 ? preview : ' '\n        } else {\n          note.content.preview_plain = text\n        }\n\n        // We're only using plain in this block.\n        note.content.preview_html = null\n      }\n    })\n  }\n\n  /**\n   * Whether or not FileSafe is configured with integrations and keys, and can handle file uploads.\n   * If not, user should open files modal and configure FileSafe.\n   */\n  public canUploadFiles(): boolean {\n    const credentials = this.fileSafeInstance.getAllCredentials()\n    const integrations = this.fileSafeInstance.getAllIntegrations()\n    return credentials.length > 0 && integrations.length > 0\n  }\n\n  /**\n   * Encrypts and Uploads a Javascript file object to FileSafe.\n   * @param file The file to upload.\n   * @returns A file descriptor if successful.\n   */\n  public async uploadJSFileObject(file: Blob): Promise<void> {\n    const cursorIdentifier = this.fileLoader!.insertStatusAtCursor('Processing file...')\n    return this.fileSafeInstance.encryptAndUploadJavaScriptFileObject(file).then(() => {\n      this.fileLoader!.removeCursorStatus(cursorIdentifier)\n    })\n  }\n\n  /**\n   * saveItemWithPresave from the component relay.\n   */\n  public saveItemWithPresave(note: ItemMessagePayload, presave?: () => void): void {\n    this.componentRelay!.saveItemWithPresave(note, presave)\n  }\n\n  /**\n   * Gets the current platform where the component is running.\n   */\n   public get platform(): string | undefined {\n    return this.componentRelay!.platform\n  }\n\n  /**\n   * Gets the current environment where the component is running.\n   */\n  public get environment(): string | undefined {\n    return this.componentRelay!.environment\n  }\n\n  /**\n   * Whether or not FileSafe can be used.\n   */\n  public canUseFileSafe(): boolean {\n    return this.fileSafeInstance.hasLegacyAccess()\n  }\n}\n"],"sourceRoot":""}