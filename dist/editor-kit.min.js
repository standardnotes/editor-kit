!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("filesafe-js")):"function"==typeof define&&define.amd?define("EditorKit",["filesafe-js"],t):"object"==typeof exports?exports.EditorKit=t(require("filesafe-js")):e.EditorKit=t(e["filesafe-js"])}(self,(function(e){return(()=>{var t,s,i={156:e=>{self,e.exports=(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};let s,i,n,o;var a;e.d(t,{default:()=>C}),function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error",e.ThemesActivated="themes-activated",e.KeyDown="key-down",e.KeyUp="key-up",e.Click="click"}(s||(s={})),function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(i||(i={})),function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(n||(n={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor",e.ComponentInstallError="installError"}(o||(o={}));var r=new Uint8Array(16);function l(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(r)}const c=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,d=function(e){return"string"==typeof e&&c.test(e)};for(var m=[],h=0;h<256;++h)m.push((h+256).toString(16).substr(1));const u=function(e,t,s){var i=(e=e||{}).random||(e.rng||l)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){s=s||0;for(var n=0;n<16;++n)t[s+n]=i[n];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase();if(!d(s))throw TypeError("Stringified UUID is invalid");return s}(i)},p=e=>{var t;const s={[i.Web]:"web",[i.Desktop]:"desktop",[i.Mobile]:"mobile"};return null!==(t=s[e])&&void 0!==t?t:s[i.Web]},f=e=>null!=e,g=()=>{};class v{static get isSupported(){return!(!window.console&&!console)}static get info(){return v.isSupported&&this.enabled?console.log.bind(console):g}static get error(){return v.isSupported?console.error.bind(console):g}}var y,b,S,E;function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function I(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){w(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function w(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}(b="enabled")in(y=v)?Object.defineProperty(y,b,{value:!1,enumerable:!0,configurable:!0,writable:!0}):y[b]=!1,function(e){e.Component="component"}(S||(S={})),function(e){e.Shift="Shift",e.Ctrl="Control",e.Meta="Meta"}(E||(E={}));class C{constructor(e){if(w(this,"contentWindow",void 0),w(this,"initialPermissions",void 0),w(this,"onReadyCallback",void 0),w(this,"component",{activeThemes:[],acceptsThemes:!0}),w(this,"sentMessages",[]),w(this,"messageQueue",[]),w(this,"lastStreamedItem",void 0),w(this,"pendingSaveItems",void 0),w(this,"pendingSaveTimeout",void 0),w(this,"pendingSaveParams",void 0),w(this,"coallesedSaving",!0),w(this,"coallesedSavingDelay",250),w(this,"messageHandler",void 0),w(this,"keyDownEventListener",void 0),w(this,"keyUpEventListener",void 0),w(this,"clickEventListener",void 0),w(this,"onThemesChangeCallback",void 0),w(this,"concernTimeouts",[]),!e||!e.targetWindow)throw new Error("contentWindow must be a valid Window object.");this.contentWindow=e.targetWindow,this.processParameters(e),this.registerMessageHandler(),this.registerKeyboardEventListeners(),this.registerMouseEventListeners()}processParameters(e){var t;const{initialPermissions:s,options:i,onReady:n,onThemesChange:o}=e;var a;s&&s.length>0&&(this.initialPermissions=s),f(null==i?void 0:i.coallesedSaving)&&(this.coallesedSaving=i.coallesedSaving),f(null==i?void 0:i.coallesedSavingDelay)&&(this.coallesedSavingDelay=i.coallesedSavingDelay),f(null==i?void 0:i.acceptsThemes)&&(this.component.acceptsThemes=null===(a=null==i?void 0:i.acceptsThemes)||void 0===a||a),f(n)&&(this.onReadyCallback=n),f(o)&&(this.onThemesChangeCallback=o),v.enabled=null!==(t=null==i?void 0:i.debug)&&void 0!==t&&t}deinit(){this.onReadyCallback=void 0,this.component={acceptsThemes:!0,activeThemes:[]},this.messageQueue=[],this.sentMessages=[],this.lastStreamedItem=void 0,this.pendingSaveItems=void 0,this.pendingSaveTimeout=void 0,this.pendingSaveParams=void 0,this.messageHandler&&(this.contentWindow.document.removeEventListener("message",this.messageHandler),this.contentWindow.removeEventListener("message",this.messageHandler)),this.keyDownEventListener&&this.contentWindow.removeEventListener("keydown",this.keyDownEventListener),this.keyUpEventListener&&this.contentWindow.removeEventListener("keyup",this.keyUpEventListener),this.clickEventListener&&this.contentWindow.removeEventListener("click",this.clickEventListener)}registerMessageHandler(){this.messageHandler=e=>{if(v.info("Components API Message received:",e.data),document.referrer&&new URL(document.referrer).origin!==new URL(e.origin).origin)return;const{data:t}=e,i=(e=>{if("string"!=typeof e)return!1;try{const t=JSON.parse(e),s=Object.prototype.toString.call(t);return"[object Object]"===s||"[object Array]"===s}catch(e){return!1}})(t)?JSON.parse(t):t;if(i){if(void 0===this.component.origin&&i.action===s.ComponentRegistered)this.component.origin=e.origin;else if(e.origin!==this.component.origin)return;this.handleMessage(i)}else v.error("Invalid data received. Skipping...")},this.contentWindow.document.addEventListener("message",this.messageHandler,!1),this.contentWindow.addEventListener("message",this.messageHandler,!1),v.info("Waiting for messages...")}registerKeyboardEventListeners(){this.keyDownEventListener=e=>{v.info("A key has been pressed: ".concat(e.key)),e.ctrlKey?this.keyDownEvent(E.Ctrl):e.shiftKey?this.keyDownEvent(E.Shift):(e.metaKey||"Meta"===e.key)&&this.keyDownEvent(E.Meta)},this.keyUpEventListener=e=>{v.info("A key has been released: ".concat(e.key)),"Control"===e.key?this.keyUpEvent(E.Ctrl):"Shift"===e.key?this.keyUpEvent(E.Shift):"Meta"===e.key&&this.keyUpEvent(E.Meta)},this.contentWindow.addEventListener("keydown",this.keyDownEventListener,!1),this.contentWindow.addEventListener("keyup",this.keyUpEventListener,!1)}registerMouseEventListeners(){this.clickEventListener=e=>{v.info("A click has been performed."),this.mouseClickEvent()},this.contentWindow.addEventListener("click",this.clickEventListener,!1)}handleMessage(e){switch(e.action){case s.ComponentRegistered:this.component.sessionKey=e.sessionKey,e.componentData&&(this.component.data=e.componentData),this.onReady(e.data),v.info("Component successfully registered with payload:",e);break;case s.ActivateThemes:this.activateThemes(e.data.themes);break;default:{var t,i;if(!e.original)return;const s=null===(t=this.sentMessages)||void 0===t?void 0:t.filter((t=>{var s;return t.messageId===(null===(s=e.original)||void 0===s?void 0:s.messageId)}))[0];if(!s){const e=this.contentWindow.document.title,t=("The extension '".concat(e,"' is attempting to communicate with Standard Notes, ")+"but an error is preventing it from doing so. Please restart this extension and try again.").replace("  "," ");return void v.info(t)}null==s||null===(i=s.callback)||void 0===i||i.call(s,e.data);break}}}onReady(e){this.component.environment=e.environment,this.component.platform=e.platform,this.component.uuid=e.uuid,this.initialPermissions&&this.initialPermissions.length>0&&this.requestPermissions(this.initialPermissions);for(const e of this.messageQueue)this.postMessage(e.action,e.data,e.callback);this.messageQueue=[],v.info("Data passed to onReady:",e),this.activateThemes(e.activeThemeUrls||[]),this.postMessage(s.ThemesActivated,{}),this.onReadyCallback&&this.onReadyCallback()}getSelfComponentUUID(){return this.component.uuid}isRunningInDesktopApplication(){return this.component.environment===p(i.Desktop)}isRunningInMobileApplication(){return this.component.environment===p(i.Mobile)}getComponentDataValueForKey(e){if(this.component.data)return this.component.data[e]}setComponentDataValueForKey(e,t){if(!this.component.data)throw new Error("The component has not been initialized.");if(!e||e&&0===e.length)throw new Error("The key for the data value should be a valid string.");this.component.data=I(I({},this.component.data),{},{[e]:t}),this.postMessage(s.SetComponentData,{componentData:this.component.data})}clearComponentData(){this.component.data={},this.postMessage(s.SetComponentData,{componentData:this.component.data})}postMessage(e,t,s){if(!this.component.sessionKey)return void this.messageQueue.push({action:e,data:t,api:S.Component,callback:s});const i={action:e,data:t,messageId:this.generateUUID(),sessionKey:this.component.sessionKey,api:S.Component},n=JSON.parse(JSON.stringify(i));let o;n.callback=s,this.sentMessages.push(n),o=this.isRunningInMobileApplication()?JSON.stringify(i):i,v.info("Posting message:",o),this.contentWindow.parent.postMessage(o,this.component.origin)}requestPermissions(e,t){this.postMessage(s.RequestPermissions,{permissions:e},(()=>{t&&t()}))}activateThemes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(!this.component.acceptsThemes)return;v.info("Incoming themes:",e);const{activeThemes:t}=this.component;if(t&&t.sort().toString()==e.sort().toString())return;let s=e;const i=[];for(const n of t)e.includes(n)?s=s.filter((e=>e!==n)):i.push(n);v.info("Deactivating themes:",i),v.info("Activating themes:",s);for(const e of i)this.deactivateTheme(e);this.component.activeThemes=e;for(const e of s){if(!e)continue;const t=this.contentWindow.document.createElement("link");t.id=btoa(e),t.href=e,t.type="text/css",t.rel="stylesheet",t.media="screen,print",t.className="custom-theme",this.contentWindow.document.getElementsByTagName("head")[0].appendChild(t)}this.onThemesChangeCallback&&this.onThemesChangeCallback()}themeElementForUrl(e){return Array.from(this.contentWindow.document.getElementsByClassName("custom-theme")).slice().find((t=>t.id==btoa(e)))}deactivateTheme(e){const t=this.themeElementForUrl(e);t&&t.parentNode&&(t.setAttribute("disabled","true"),t.parentNode.removeChild(t))}generateUUID(){return u()}get platform(){return this.component.platform}get environment(){return this.component.environment}streamItems(e,t){this.postMessage(s.StreamItems,{content_types:e},(e=>{t(e.items)}))}streamContextItem(e){this.postMessage(s.StreamContextItem,{},(t=>{const{item:s}=t;(!this.lastStreamedItem||this.lastStreamedItem.uuid!==s.uuid)&&this.pendingSaveTimeout&&(clearTimeout(this.pendingSaveTimeout),this.performSavingOfItems(this.pendingSaveParams),this.pendingSaveTimeout=void 0,this.pendingSaveParams=void 0),this.lastStreamedItem=s,e(this.lastStreamedItem)}))}selectItem(e){this.postMessage(s.SelectItem,{item:this.jsonObjectForItem(e)})}clearSelection(){this.postMessage(s.ClearSelection,{content_type:n.Tag})}createItem(e,t){this.postMessage(s.CreateItem,{item:this.jsonObjectForItem(e)},(e=>{let{item:s}=e;!s&&e.items&&e.items.length>0&&(s=e.items[0]),this.associateItem(s),t&&t(s)}))}createItems(e,t){const i=e.map((e=>this.jsonObjectForItem(e)));this.postMessage(s.CreateItems,{items:i},(e=>{t&&t(e.items)}))}associateItem(e){this.postMessage(s.AssociateItem,{item:this.jsonObjectForItem(e)})}deassociateItem(e){this.postMessage(s.DeassociateItem,{item:this.jsonObjectForItem(e)})}deleteItem(e,t){this.deleteItems([e],t)}deleteItems(e,t){const i={items:e.map((e=>this.jsonObjectForItem(e)))};this.postMessage(s.DeleteItems,i,(e=>{t&&t(e)}))}sendCustomEvent(e,t,s){this.postMessage(e,t,(e=>{s&&s(e)}))}saveItem(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.saveItems([e],t,s)}saveItemWithPresave(e,t,s){this.saveItemsWithPresave([e],t,s)}saveItemsWithPresave(e,t,s){this.saveItems(e,s,!1,t)}performSavingOfItems(e){let{items:t,presave:i,callback:n}=e;const o=setTimeout((()=>{this.concernTimeouts.forEach((e=>clearTimeout(e))),alert("This editor is unable to communicate with Standard Notes. Your changes may not be saved. Please backup your changes, then restart the application and try again.")}),5e3);this.concernTimeouts.push(o),i&&i();const a=[];for(const e of t)a.push(this.jsonObjectForItem(e));this.postMessage(s.SaveItems,{items:a},(()=>{this.concernTimeouts.forEach((e=>clearTimeout(e))),null==n||n()}))}saveItems(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(this.pendingSaveItems||(this.pendingSaveItems=[]),this.coallesedSaving&&!s){this.pendingSaveTimeout&&clearTimeout(this.pendingSaveTimeout);const s=e.map((e=>e.uuid)),n=this.pendingSaveItems.filter((e=>!s.includes(e.uuid)));this.pendingSaveItems=n.concat(e),this.pendingSaveParams={items:this.pendingSaveItems,presave:i,callback:t},this.pendingSaveTimeout=setTimeout((()=>{this.performSavingOfItems(this.pendingSaveParams),this.pendingSaveItems=[],this.pendingSaveTimeout=void 0,this.pendingSaveParams=null}),this.coallesedSavingDelay)}else this.performSavingOfItems({items:e,presave:i,callback:t})}setSize(e,t){this.postMessage(s.SetSize,{type:"container",width:e,height:t})}keyDownEvent(e){this.postMessage(s.KeyDown,{keyboardModifier:e})}keyUpEvent(e){this.postMessage(s.KeyUp,{keyboardModifier:e})}mouseClickEvent(){this.postMessage(s.Click,{})}jsonObjectForItem(e){const t=Object.assign({},e);return t.children=null,t.parent=null,t}getItemAppDataValue(e,t){var s,i;return null==e||null===(s=e.content)||void 0===s||null===(i=s.appData)||void 0===i?void 0:i["org.standardnotes.sn"][t]}}return t.default})()},695:t=>{"use strict";t.exports=e}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={exports:{}};return i[e](s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},s=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(e,i){if(1&i&&(e=this(e)),8&i)return e;if("object"==typeof e&&e){if(4&i&&e.__esModule)return e;if(16&i&&"function"==typeof e.then)return e}var n=Object.create(null);o.r(n);var a={};t=t||[null,s({}),s([]),s(s)];for(var r=2&i&&e;"object"==typeof r&&!~t.indexOf(r);r=s(r))Object.getOwnPropertyNames(r).forEach((t=>a[t]=()=>e[t]));return a.default=()=>e,o.d(n,a),n},o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{"use strict";o.d(a,{default:()=>u});var e=o(156),t=o.n(e);const s=async e=>{await new Promise((t=>setTimeout(t,1e3*e)))};function i(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class n{constructor(e){this.options=e,i(this,"uuidToFileTempUrlAndTypeMapping",{}),i(this,"currentlyLoadingIds",[]),i(this,"statusElementMapping",{}),i(this,"fileTypeToElementType",{"image/png":"img","image/jpg":"img","image/jpeg":"img","image/gif":"img","image/tiff":"img","image/bmp":"img","video/mp4":"video","audio/mpeg":"audio","audio/mp3":"audio"})}fileTypeForElementType(e){return this.fileTypeToElementType[e.toLowerCase()]}loadFileSafeElements(){const e=this.options.getElementsBySelector("*[fsplaceholder]");for(const t of e)this.loadFileSafeElement(t)}async loadFileSafeElement(e){var t;const{fileSafeInstance:i}=this.options,n=e.getAttribute("fsid"),o=null!==(t=e.getAttribute("fsName"))&&void 0!==t?t:"",a=o&&"undefined"!=o?o:"file";if(!n)return!1;const r=this.uuidToFileTempUrlAndTypeMapping[n];if(r)return this.insertMediaElement({fsid:n,fsElement:e,url:r.url,fileType:r.fileType,fsName:r.fsName}),!1;if(this.currentlyLoadingIds.includes(n))return!1;const l=i.findFileDescriptor(n);if(!l)return this.setStatus({fsElement:e,fsid:n,status:"Unable to find ".concat(a," ").concat(n,"."),removable:!0}),!1;const c='[fsid="'.concat(l.uuid,'"][fscollapsable]');if(document.querySelectorAll("img".concat(c,", figure").concat(c,", video").concat(c,", audio").concat(c)).length>0)return!1;this.currentlyLoadingIds.push(n),this.setStatus({fsElement:e,fsid:n,status:"Downloading ".concat(a,"...")}),await s(.05);const d=await i.downloadFileFromDescriptor(l).catch((()=>{this.setStatus({fsElement:e,fsid:n,status:"Unable to download ".concat(a," ").concat(n,".")})}));if(!d)return!1;this.setStatus({fsElement:e,fsid:n,status:"Decrypting ".concat(a,"...")}),await s(.05);const m=await i.decryptFile({fileDescriptor:l,fileItem:d}).catch((()=>{this.setStatus({fsElement:e,fsid:n,status:"Unable to decrypt ".concat(a," ").concat(n,".")})}));if(!m)return!1;this.setStatus({fsElement:e,fsid:n}),await s(.05);const h=l.content.fileType,u=i.createTemporaryFileUrl({base64Data:m.decryptedData,dataType:h});return this.insertMediaElement({fsid:n,fileType:h,fsName:o,fsElement:e,url:u}),(()=>{this.currentlyLoadingIds.splice(this.currentlyLoadingIds.indexOf(n),1)})(),this.uuidToFileTempUrlAndTypeMapping[n]={fileType:h,url:u,fsName:o},!0}insertMediaElement(e){let{url:t,fsid:s,fsName:i,fileType:n,fsElement:o}=e;let a;switch(this.fileTypeForElementType(n)){case"img":a=this.createImageElement({url:t,fsid:s,fsName:i,fsElement:o});break;case"video":a=this.createVideoElement({url:t,fsid:s,fileType:n,fsName:i,fsElement:o});break;case"audio":a=this.createAudioElement({url:t,fsid:s,fsName:i});break;default:a=this.createDownloadElement({url:t,fsid:s,fsName:i})}this.insertElementNearElement(a,o),o.remove()}wrapElementInTag(e){let{element:t,tagName:s,fsid:i,fsName:n}=e;const o=document.createElement(s);return o.setAttribute("fsid",i),o.setAttribute("fsName",n),o.setAttribute("fscollapsable","true"),o.setAttribute("contenteditable","true"),o.append(t),o}createImageElement(e){let{url:t,fsid:s,fsName:i,fsElement:n}=e;const o=document.createElement("img");o.setAttribute("src",t),o.setAttribute("srcset","".concat(t," 2x")),o.setAttribute("fsid",s),o.setAttribute("fsName",i),o.setAttribute("fscollapsable","true");const a=n.getAttribute("width");a&&o.setAttribute("width",a);const r=n.getAttribute("height");return r&&o.setAttribute("height",r),o}createVideoElement(e){let{url:t,fsid:s,fileType:i,fsName:n,fsElement:o}=e;const a=document.createElement("video");a.setAttribute("controls","true"),a.setAttribute("fsid",s),a.setAttribute("fsName",n),a.setAttribute("fscollapsable","true");const r=o.getAttribute("width");r&&a.setAttribute("width",r);const l=o.getAttribute("height");l&&a.setAttribute("height",l);const c=document.createElement("source");return c.setAttribute("src",t),c.setAttribute("type",i),a.append(c),this.wrapElementInTag({fsid:s,fsName:n,element:a,tagName:"p"})}createDownloadElement(e){let{url:t,fsid:s,fsName:i}=e;const n=document.createElement("a");return n.setAttribute("fsid",s),n.setAttribute("fsName",i),n.setAttribute("ghost","true"),n.setAttribute("fscollapsable","true"),n.setAttribute("href",t),n.textContent="".concat(i),n}createAudioElement(e){let{url:t,fsid:s,fsName:i}=e;const n=document.createElement("audio");return n.setAttribute("src",t),n.setAttribute("controls","true"),n.setAttribute("fsid",s),n.setAttribute("fsName",i),n.setAttribute("fscollapsable","true"),this.wrapElementInTag({fsid:s,fsName:i,element:n,tagName:"p"})}setStatus(e){let{status:t,fsElement:s,fsid:i,removable:n=!1}=e;if(i){const e=this.statusElementMapping[i];e&&(e.remove(),delete this.statusElementMapping[i])}if(t){let e=document.createElement("label");return e.setAttribute("id",i),e.setAttribute("ghost","true"),e.setAttribute("contenteditable","false"),e.style.fontWeight="bold",e.textContent=t,n&&(e.style.userSelect="all"),e=this.insertElementNearElement(e,s),i&&(this.statusElementMapping[i]=e),e}}insertStatusAtCursor(e){const t=Math.random().toString(36).substring(7);return this.setStatus({status:e,fsid:t,fsElement:null}),t}removeCursorStatus(e){const t=this.options.getElementsBySelector("#".concat(e));t.length>0&&t[0].remove()}insertElementNearElement(e,t){const s=this.options.preprocessElement(e);let i="child";if(t&&"figure"==s.tagName.toLowerCase()){const e=t.closest("p");e&&(t=e,i="afterend")}return this.options.insertElement(s,t,i),s}}class r{constructor(e){this.options=e}onKeyUp(e){let{isEnter:t,isPaste:s,isSpace:i}=e;(t||s||i)&&this.searchPatterns({searchPreviousLine:null!=t&&t})}searchPatterns(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{searchPreviousLine:!1};const t=e.searchPreviousLine?this.options.getPreviousLineText():this.options.getCurrentLineText();for(const s of this.options.patterns){const i=s.regex.exec(t);if(!i)continue;const n=i[0];if(n){const t=s.callback(n);this.replaceSelection(s.regex,t,e.searchPreviousLine)}}}replaceSelection(e,t,s){var i,n,o;(null!==(i=this.options)&&void 0!==i&&i.beforeExpand&&this.options.beforeExpand(),this.options.replaceText({regex:e,replacement:t,searchPreviousLine:s}),null!==(n=this.options)&&void 0!==n&&n.afterExpand)&&(null===(o=this.options)||void 0===o||o.afterExpand())}}const l=/(<p>)?\[FileSafe[^\]]*\](<\/p>)?/g,c=e=>e.replace(l,(e=>m(e))),d=e=>"[FileSafe:".concat(e.uuid,":").concat(e.content.fileName,"]"),m=e=>{const t=(e=(e=(e=e.replace("<p>","")).replace("</p>","")).replace("[","").replace("]","")).split(":"),s=t[1],i=t[2],n=t[3];let o="";if(n){const e=n.split("x");o="width=".concat(e[0]," height=").concat(e[1])}return"<p fsplaceholder=true style='display: none;' fscollapsable=true ghost=true fsid='".concat(s,"' fsname='").concat(i,"' ").concat(o,"></p>")};function h(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class u{constructor(e,t){this.delegate=e,this.options=t,h(this,"fileIdsPendingAssociation",[]),h(this,"componentRelay",void 0),h(this,"fileLoader",void 0),h(this,"textExpander",void 0),h(this,"fileSafeLoading",void 0),h(this,"fileSafeClass",void 0),h(this,"fileSafeInstance",void 0),h(this,"note",void 0),h(this,"ignoreNextTextChange",void 0),h(this,"needsFileSafeElementLoad",void 0),h(this,"previousText",void 0),this.connectToBridge(),this.options.supportsFileSafe&&(this.fileSafeLoading=this.importFileSafe())}connectToBridge(){const{coallesedSaving:e,coallesedSavingDelay:s,mode:i,supportsFileSafe:n}=this.options;this.componentRelay=new(t())({targetWindow:window,options:{coallesedSaving:e,coallesedSavingDelay:s},onReady:()=>{const{platform:e}=this.componentRelay;e&&document.documentElement.classList.add(e)},onThemesChange:this.delegate.onThemesChange}),this.componentRelay.streamContextItem((async e=>{let t=!0;this.note&&this.note.uuid==e.uuid&&(t=!1);const s=this.note;if(n){const t=this.fileSafeClass.getSFItemClass();this.note=new t(e),this.fileSafeInstance.setCurrentNote(this.note)}else this.note=e;if(e.isMetadataUpdate)return;let o=e.content.text;if("html"===i&&t){/<[a-z][\s\S]*>/i.test(o)||(this.ignoreNextTextChange=!0)}if(this.previousText=o,n&&(this.needsFileSafeElementLoad=!0,o=c(o)),this.delegate.onNoteValueChange&&await this.delegate.onNoteValueChange(e),this.delegate.setEditorRawText(o),this.delegate.onNoteLockToggle){var a,r;const e=null!==(a=this.componentRelay.getItemAppDataValue(s,"locked"))&&void 0!==a&&a,t=null!==(r=this.componentRelay.getItemAppDataValue(this.note,"locked"))&&void 0!==r&&r;e!==t&&this.delegate.onNoteLockToggle(t)}var l,d;t&&(null===(l=(d=this.delegate).clearUndoHistory)||void 0===l||l.call(d))}))}async importFileSafe(){return Promise.resolve().then(o.t.bind(o,695,23)).then((e=>(this.fileSafeClass=e.default,this.configureFileSafe(),this.fileSafeInstance)))}configureFileSafe(){const e=["getCurrentLineText","getPreviousLineText","replaceText","getElementsBySelector","insertElement","preprocessElement","insertRawText"];for(const t of e)if(!this.delegate[t])throw Error("Missing ".concat(t," delegate function."));this.fileSafeInstance=new this.fileSafeClass({componentManager:this.componentRelay}),this.fileSafeInstance.addDataChangeObserver((()=>{const e=this.fileSafeInstance.getAllFileDescriptors();if(this.note&&this.fileIdsPendingAssociation.length>0){let t=!1;for(const s of this.fileIdsPendingAssociation.slice()){const i=e.find((e=>e.uuid==s));if(!i)continue;t=!0,this.fileIdsPendingAssociation.splice(this.fileIdsPendingAssociation.indexOf(s),1);const n=d(i);this.delegate.insertRawText(n)}t&&this.textExpander.searchPatterns()}e.length>0&&this.fileLoader.loadFileSafeElements()})),this.fileSafeInstance.addNewFileDescriptorHandler((e=>{this.fileIdsPendingAssociation.push(e.uuid)})),this.fileLoader=new n({fileSafeInstance:this.fileSafeInstance,getElementsBySelector:this.delegate.getElementsBySelector,insertElement:this.delegate.insertElement,preprocessElement:this.delegate.preprocessElement}),this.textExpander=new r({afterExpand:()=>this.fileLoader.loadFileSafeElements(),getCurrentLineText:this.delegate.getCurrentLineText,getPreviousLineText:this.delegate.getPreviousLineText,replaceText:this.delegate.replaceText,patterns:[{regex:l,callback:e=>c(e)}]})}async getFileSafe(){return!this.fileSafeInstance&&this.fileSafeLoading?this.fileSafeLoading:this.importFileSafe()}onEditorKeyUp(e){let{isSpace:t,isEnter:s}=e;this.textExpander.onKeyUp({isSpace:t,isEnter:s})}onEditorPaste(){this.textExpander.onKeyUp({isPaste:!0})}onEditorValueChanged(e){const{mode:t,supportsFileSafe:s}=this.options;if(this.needsFileSafeElementLoad&&(this.needsFileSafeElementLoad=!1,this.fileLoader.loadFileSafeElements()),this.ignoreNextTextChange)return void(this.ignoreNextTextChange=!1);if(s){e=(e=>{const t=(new DOMParser).parseFromString(e,"text/html"),s=t.querySelectorAll("*[fscollapsable]");for(const e of s){const t=e.getAttribute("fsid"),s=e.getAttribute("fsname"),i=e.getAttribute("width"),n=e.getAttribute("height"),o=["FileSafe",t,s];if(i&&n){const e="".concat(i,"x").concat(n);o.push(e)}const a="<p>[".concat(o.join(":"),"]</p>");e.insertAdjacentHTML("afterend",a),e.remove()}return t.querySelectorAll("*[ghost]").forEach((e=>e.remove())),t.body.innerHTML})(e);if(this.previousText==e)return}if(this.previousText=e,!this.note)return;const i=this.note;this.componentRelay.saveItemWithPresave(i,(()=>{if(i.content.text=e,this.delegate.generateCustomPreview){var s;const t=this.delegate.generateCustomPreview(e);i.content.preview_plain=null!==(s=t.plain)&&void 0!==s?s:" ",i.content.preview_html=t.html}else{if("html"===t){let t=e.replace(l,(e=>""));t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:90;return e.length<=t?e:e.substring(0,t)+"..."}((e=>{const t=document.implementation.createHTMLDocument().body;return t.innerHTML=e,t.textContent||t.innerText||""})(t)),i.content.preview_plain=t.length>0?t:" "}else i.content.preview_plain=e;i.content.preview_html=null}}))}canUploadFiles(){const e=this.fileSafeInstance.getAllCredentials(),t=this.fileSafeInstance.getAllIntegrations();return e.length>0&&t.length>0}async uploadJSFileObject(e){const t=this.fileLoader.insertStatusAtCursor("Processing file...");return this.fileSafeInstance.encryptAndUploadJavaScriptFileObject(e).then((()=>{this.fileLoader.removeCursorStatus(t)}))}saveItemWithPresave(e,t){this.componentRelay.saveItemWithPresave(e,t)}get platform(){return this.componentRelay.platform}get environment(){return this.componentRelay.environment}canUseFileSafe(){return this.fileSafeInstance.hasLegacyAccess()}}})(),a=a.default})()}));
//# sourceMappingURL=editor-kit.min.js.map